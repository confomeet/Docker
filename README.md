# В данном репозитории собрана информация и скрипты, необходимые для деплоя проекта Confomeet
Содержимое данного репозитория основано на https://github.com/jitsi/docker-jitsi-meet.

Текущая используемая версия docker-jitsi-meet: stable-9364-1

## Развертывание в продакшн среде
**TODO**

## Развертывание локально (для разработки)
**TODO**

## Кастомизация self-hosted jitsi meet
Confomeet использует компоненты jitsi meet как составные части. Некоторые компоненты были доработаны, об этих
доработках рассказано ниже:

### Общие изменения
Во всех сервисах имя сети заменено с `meet.jitsi` на `confomeetnet`.

### Jibri
В контейнеры добавлена установка встроенных перменных окружения, которые используются при конфигурации jibri:
- `JIBRI_ALL_MUTED_TIMEOUT`
- `JIBRI_NO_MEDIA_TIMEOUT`

В контейнеры добавлена установка новых переменных окружения, которые используеются при конфигурации доступа к
S3 хранилищу:
- `CONFOMEET_S3_URL`
- `CONFOMEET_S3_CLIENT_ID`
- `CONFOMEET_S3_CLIENT_SECRET`
- `CONFOMEET_S3_REGION`
- `CONFOMEET_S3_BUCKET`

Добавлены файлы для поддержки загрузки записей в хранилище S3.
- rootfs/defaults/aws-config.conf
- rootfs/defaults/aws-credentials.conf
- rootfs/etc/cont-init.d/11-awscli
- rootfs/etc/fit-attrs.d/11-awscli
- rootfs/usr/bin/install-awscli
- rootfs/usr/bin/finalize-s3.sh

_Важно._ Чтобы добавить необходимые файлы мы собираем свой контейнер jibri. При обновлении на новую версию
docker-jitsi-meet об этом надо помнить.

### Jicofo
Мы подменяем настройку `jicofo.conference.shared-document.use-random-name`. Данная настройка в текущий момент не
вынесена в конфигурацию _jicofo_ через перменные окружения, поэтому мы делаем эту настройку напрямую в конфиге _jicofo_
и собираем свой образ контейнера _jicofo_.

_Важно._ Чтобы добавить необходимые файлы мы собираем свой контейнер _jicofo_. При обновлении на новую версию
_docker-jitsi-meet_ об этом надо помнить.


### Prosody
Мы используем собранный образ _prosody_, но подменяем путь, из которого монтируется директория с кастомными плагинами,
т.к. плагины удобно хранить в репозитории, а логи, инстанциированные из шаблонов конфиги и другие артефакты работы
системы в отдельном месте.

Для сервера prosody мы разработали дополнительные модули, которые используем для реализации функций, которых нет в jitsi-meet.

#### Плагин mod_confomeet_context
`mod_confomeet_context` - это базовый модуль, который встраивается в процесс авторизации по jwt токену,
реализованный в плагине `mod_auth_token`. Наш модуль подписывется на событие `jitsi-authentication-token-verified`,
и когда оно наступает обогащает сессию пользователя данными из jwt токена.
При таком подходе нам не приходится парсить и валидировать jwt токен в каждом нашем плагине повторно, что в свою
очередь упрощает конфигурацию, т.к. для новых плагинов не требуется конфигурировать общий секрет и идентификатор
приложения, которые нужны для валидации токена.

Файл с плагином: _confomeet/prosody/prosody-plugins-custom_

Сессия пользователя обогащется следующими данными:
* autoLobby: bool - флаг, отражающий, нужно ли включать комнату ожидания для данной конференции.
* moderator: bool - флаг, отражающий, является ли данный пользователь модератором конференции.
* autoRec: bool - флаг, отражающий, нужно ли автоматически включать запись данной конференции.
* singleAccess: bool - флаг, отражающий, нужно ли контролировать, что пользователи могу присоединиться к конференции
под одним аккаунтом только один раз.
* anonymous: bool - флаг, отражающий являтся ли данный пользователь анонимом, т.е. незарегистрированным в системе,
например если пользователь присоединяется по публичный ссылке конференции.
* user_id: string - уникальный идентификатор пользователя, зарегистрированного в нашей системе, если пользователь не
анонимный. Если пользователь анонимный, то строка пустая.
* user_email: string - электронный адрес пользователя, если это не аноним. Если участник аноним, то строка пустая.
* participant_guid: string - уникальный идентификатор участника конференции, выдаваемый бэкендом.

#### Плагин mod_conf_http_log
`mod_conf_http_log` - это плагин, собирающий события происходящие в конференции и отправляющий их в бэкэнд, для
дальнейшего анализа модулем статистики.

Плагин сигнализирует о следующих событиях:
* `room_created` - создана конференции.
* `occupant_joined` - участник присоединился к конференции.
* `occupant_leaving` - участник покинул конференцию.
* `room_destroyed` - конференция завершена.

Перед использованием плагин не обходимо сконфигурировать задав параметер `conference_logger_url`.

Файл с плагином: _confomeet/prosody/porosody-plugins-custom/mod\_conf\_http\_log.lua_

#### Плагин mod_auto_lobby
`mod_auto_lobby` - это плагин, который проверяет наличие флага autoLobby в сессии пользователя и включает комнату
ожидания, если флаг выставлен. Данный плагин требует, чтобы был включен плагин `muc_lobby_rooms`, входящий в поставку docker-jits-meet.
При создании конференеции плагин создает комнату ожидания, а когда в комнату начинаются присоединяться
участники, перенапрвляет в комнату ожидания вместо комнаты конференции всех участников, в сессии которых флаг `autoLobby`
выставлен, а флаг `moderator` не выставлен.

Файл с плагином: _confomeet/prosody/prosody-plugins-custom/mod\_auto\_lobby.lua_

#### Плагин mod_grant_moderator_rights
`mod_grant_moderator_rights` - это плагин, который выдает права модератора всем участникам, у которых в сессии выставлен
флаг `moderator` и забирает выдаваемые jitsi по умолчанию права модератора у тех участников, в чьей сесси этот флаг
не выставлен.

Файл с плагином: _confomeet/prosody/prosody-plugins-custom/mod\_grant\_moderator\_rights.lua_.

#### Плагин mod_jibri_autostart
`mod_jibri_autostart` - это плагин, который при присоединении модератора к конференции проверяет, выставлен ли в его
сессии флаг `autoRec`, и запускает запись конференции, если данный флаг выставлен.

Файл с плагином: _confomeet/prosody/prosody-plugins-custom/mod\_jibri\_autostart.lua_


#### Плагин mod_kick_back_to_lobby
`mod_kick_back_to_lobby` - это плагин, который позволяет модератору конференции отправлять участников в комнату ожидания,
откуда эти участники могут снова попытаться присоединиться к встрече, проходя через процесс одобрения их присоединения
модератором.

Данный плагин обрабатывает специальный запрос, отправляемый модератором конференции по специальному протоколу расширению
протокола xmpp. Данный запрос и ответ на него требуют поддержки со стороны клиентского кода, поэтому данный плагин
работает только с нашей версией jitsi-meet, которая была доработана для поддержки данного функционала.

Файл с плагином: _confomeet/prosody/prosody-plugins-custom/mod\_kick\_back\_to\_lobby.lua_.

#### Плагин mod_single_access
`mod_single_access` - это плагин, позволяющий контролировать, чтобы только каждый учетная запись, под которой участник
присоединился к конференции была в данной конфернеции в единственной. Плагин не позволяет пользователю повторно
присоединиться к конференции с другого устройства или из другой вкладки браузера.

Если в сессии пользователя выставлен флаг `singleAccess`, то при попытке его присоединения к конференции плагин
сравнивает `participant_guid` из сессии каждого участника с `participant_guid` в сессии данного участника. И запрещает
подключение нового пользователя к конференции, если в комнате конференции уже есть пользователь с такими же данными.

Файл с плагином: _confomeet/prosody/prosody-plugins-custom/mod\_mod\_single\_access.lua_.

## Обновление на новую версию docker-jitsi-meet
